<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Iron & Blood: Global Conquest 2025 (Final Fix)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;600;700&family=Rajdhani:wght@500;700&display=swap');

        :root {
            --bg-dark: #020617;
            --panel-bg: rgba(15, 23, 42, 0.95);
            --border: 1px solid rgba(148, 163, 184, 0.15);
            --neon-blue: #38bdf8;
            --neon-red: #f87171;
            --neon-green: #4ade80;
            --gold: #facc15;
            --text: #f1f5f9;
        }

        body, html { margin: 0; padding: 0; width: 100%; height: 100%; font-family: 'Chakra Petch', sans-serif; background: var(--bg-dark); overflow: hidden; color: var(--text); user-select: none; }

        /* HARİTA KONTEYNERİ (BU KISIM ÇOK ÖNEMLİ) */
        #map { position: absolute; top: 0; bottom: 0; width: 100%; z-index: 1; background: #0b0f19; }

        /* ARAYÜZ KATMANI */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1000; display: flex; flex-direction: column; justify-content: space-between; }
        .interactive { pointer-events: auto; }

        /* ÜST BAR */
        #top-bar {
            background: linear-gradient(180deg, rgba(2,6,23,0.95), rgba(15,23,42,0.9));
            border-bottom: var(--border); padding: 12px 25px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5); backdrop-filter: blur(5px);
        }

        .flag-box { 
            width: 56px; height: 36px; background: #1e293b; border: 2px solid #fff; 
            display: flex; align-items: center; justify-content: center; 
            font-weight: 800; margin-right: 15px; color: white;
            box-shadow: 0 0 15px rgba(56, 189, 248, 0.4); text-shadow: 1px 1px 2px black;
        }

        .resources { display: flex; gap: 25px; background: rgba(30, 41, 59, 0.5); padding: 8px 20px; border-radius: 6px; border: var(--border); }
        .res-item { display: flex; flex-direction: column; align-items: center; justify-content: center; min-width: 60px; }
        .res-icon { font-size: 14px; color: #94a3b8; margin-bottom: 2px; }
        .res-val { color: var(--text); font-family: 'Rajdhani', monospace; font-size: 18px; font-weight: bold; line-height: 1; }
        .res-label { font-size: 9px; color: #64748b; text-transform: uppercase; font-weight: 700; margin-top: 2px; }

        /* HABERLER */
        #news-feed { 
            position: absolute; top: 90px; left: 20px; width: 380px; 
            display: flex; flex-direction: column; gap: 10px; pointer-events: none; 
        }
        .news-item {
            background: rgba(15, 23, 42, 0.95); border-left: 4px solid var(--neon-blue);
            padding: 15px; font-size: 13px; color: #e2e8f0; border-radius: 0 4px 4px 0;
            box-shadow: 5px 5px 20px rgba(0,0,0,0.5); animation: slideIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            pointer-events: auto; border-top: 1px solid rgba(255,255,255,0.05); display: flex; align-items: center; gap: 10px;
        }
        .news-war { border-left-color: var(--neon-red); background: linear-gradient(90deg, rgba(69,10,10,0.9), rgba(15,23,42,0.95)); }
        .news-win { border-left-color: var(--neon-green); background: linear-gradient(90deg, rgba(6,78,59,0.9), rgba(15,23,42,0.95)); }
        @keyframes slideIn { from { opacity:0; transform:translateX(-50px); } to { opacity:1; transform:translateX(0); } }

        /* ALT PANEL */
        #bottom-panel {
            background: var(--panel-bg); border-top: var(--border);
            height: 260px; display: flex; backdrop-filter: blur(10px);
            box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
        }

        #country-detail { width: 320px; padding: 20px; border-right: var(--border); background: rgba(0,0,0,0.2); display: flex; flex-direction: column; }
        .detail-header { font-size: 26px; font-weight: 800; color: white; text-transform: uppercase; margin-bottom: 2px; letter-spacing: 1px; }
        
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: auto; }
        .stat-box { 
            background: rgba(255,255,255,0.03); padding: 8px 12px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.05);
            display: flex; justify-content: space-between; align-items: center; font-size: 12px;
        }

        #command-center { flex: 1; display: flex; flex-direction: column; }
        .tabs { display: flex; background: rgba(0,0,0,0.4); border-bottom: var(--border); }
        .tab {
            flex: 1; padding: 12px; text-align: center; cursor: pointer;
            font-size: 12px; font-weight: 800; color: #64748b; transition: 0.2s; letter-spacing: 1px;
            border-right: 1px solid rgba(255,255,255,0.05); position: relative;
        }
        .tab.active { color: var(--neon-blue); background: rgba(56, 189, 248, 0.05); }
        .tab.active::after { content:''; position:absolute; bottom:0; left:0; width:100%; height:2px; background:var(--neon-blue); box-shadow: 0 0 10px var(--neon-blue); }

        .action-grid { padding: 20px; display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; overflow-y: auto; }
        
        .cmd-btn {
            background: linear-gradient(145deg, #1e293b, #0f172a); border: 1px solid #334155;
            color: #cbd5e1; border-radius: 6px; cursor: pointer; height: 90px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: all 0.2s; position: relative; overflow: hidden;
        }
        .cmd-btn:hover { border-color: var(--neon-blue); color: white; transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .btn-war:hover { border-color: var(--neon-red); box-shadow: 0 5px 15px rgba(239, 68, 68, 0.2); }
        .btn-eco:hover { border-color: var(--neon-green); box-shadow: 0 5px 15px rgba(34, 197, 94, 0.2); }

        #next-turn-btn {
            width: 160px; border: none; color: white; cursor: pointer;
            font-family: 'Rajdhani', sans-serif; font-size: 24px; font-weight: 800;
            background: linear-gradient(135deg, #0284c7 0%, #0369a1 100%);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: 0.3s; border-left: var(--border); box-shadow: -5px 0 20px rgba(0,0,0,0.4);
        }
        #next-turn-btn:hover { background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%); }
    </style>
</head>
<body>

<!-- HARİTA DİV'İ BURADA OLMALI -->
<div id="map"></div>

<div id="ui-layer">
    <div id="top-bar" class="interactive">
        <div style="display:flex; align-items:center;">
            <div class="flag-box" id="player-flag">TR</div>
            <div>
                <div style="font-weight:bold; font-size:20px; color:white; line-height:1;" id="player-country">TÜRKİYE</div>
                <div style="font-size:11px; color:var(--neon-blue); font-weight:600;">OYUNCU DEVLETİ</div>
            </div>
        </div>

        <div class="resources">
            <div class="res-item">
                <i class="fa-solid fa-landmark res-icon"></i><span class="res-val" id="res-pp">250</span><span class="res-label">Pol. Güç</span>
            </div>
            <div class="res-item">
                <i class="fa-solid fa-sack-dollar res-icon" style="color:var(--gold)"></i><span class="res-val" id="res-money">1500$</span><span class="res-label">Hazine</span>
            </div>
            <div class="res-item">
                <i class="fa-solid fa-person-military-rifle res-icon" style="color:var(--neon-red)"></i><span class="res-val" id="res-man">85M</span><span class="res-label">İnsan Gücü</span>
            </div>
            <div class="res-item">
                <i class="fa-solid fa-industry res-icon" style="color:var(--neon-green)"></i><span class="res-val" id="res-fac">45</span><span class="res-label">Sanayi</span>
            </div>
             <div class="res-item">
                <i class="fa-solid fa-fire res-icon" style="color:#f97316"></i><span class="res-val" id="res-stab">100%</span><span class="res-label">İstikrar</span>
            </div>
        </div>

        <div style="text-align:right">
            <div style="font-size:10px; color:#94a3b8; font-weight:bold; letter-spacing:2px; margin-bottom:2px;">KÜRESEL ZAMAN</div>
            <div style="font-family:'Rajdhani', monospace; font-size:24px; font-weight:bold; color:white;" id="game-date">OCA 2025</div>
        </div>
    </div>

    <div id="news-feed" class="interactive"></div>

    <div id="bottom-panel" class="interactive">
        <div id="country-detail">
            <div class="detail-header" id="sel-name">DÜNYA</div>
            <div style="font-size:12px; color:#94a3b8; margin-bottom:15px; display:flex; gap:10px;">
                <span id="sel-ideo" style="font-weight:bold; color:white;">-</span>
                <span>•</span>
                <span id="sel-status">Barışta</span>
            </div>
            
            <div class="stat-grid">
                <div class="stat-box"><span><i class="fa-solid fa-heart" style="color:#f472b6"></i> İlişki:</span> <span id="sel-rel" style="font-weight:bold">0</span></div>
                <div class="stat-box"><span><i class="fa-solid fa-shield-halved" style="color:var(--neon-blue)"></i> Ordu:</span> <span id="sel-army" style="font-weight:bold">-</span></div>
                <div class="stat-box"><span><i class="fa-solid fa-coins" style="color:var(--gold)"></i> Para:</span> <span id="sel-money">-</span></div>
                <div class="stat-box"><span><i class="fa-solid fa-industry" style="color:var(--neon-green)"></i> Fabrika:</span> <span id="sel-fac">-</span></div>
            </div>
        </div>

        <div id="command-center">
            <div class="tabs">
                <div class="tab active" onclick="Game.setTab('prod')"><i class="fa-solid fa-gavel"></i> YÖNETİM</div>
                <div class="tab" onclick="Game.setTab('diplo')"><i class="fa-solid fa-globe"></i> DİPLOMASİ</div>
                <div class="tab" onclick="Game.setTab('intel')"><i class="fa-solid fa-eye"></i> İSTİHBARAT</div>
            </div>
            <div id="action-area" class="action-grid"></div>
        </div>

        <button id="next-turn-btn" onclick="Game.nextTurn()">
            <div style="font-size:11px; opacity:0.7; font-weight:600; margin-bottom:2px;">SONRAKİ AY</div>
            İLERLE <i class="fa-solid fa-forward" style="font-size:18px; margin-left:5px;"></i>
        </button>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// --- OYUN KODLARI ---

const REAL_DB = {
    'TUR': { name: 'Türkiye', ideo: 'democracy', manpower: 85000, factories: 60, money: 2000, army: 600 },
    'USA': { name: 'ABD', ideo: 'democracy', manpower: 335000, factories: 450, money: 25000, army: 1500 },
    'CHN': { name: 'Çin', ideo: 'autocracy', manpower: 1400000, factories: 400, money: 18000, army: 2200 },
    'RUS': { name: 'Rusya', ideo: 'autocracy', manpower: 140000, factories: 150, money: 5000, army: 1200 },
    'GER': { name: 'Almanya', ideo: 'democracy', manpower: 84000, factories: 180, money: 6000, army: 300 },
    'FRA': { name: 'Fransa', ideo: 'democracy', manpower: 68000, factories: 140, money: 5000, army: 350 },
    'GBR': { name: 'İngiltere', ideo: 'democracy', manpower: 67000, factories: 130, money: 4800, army: 300 },
    'JPN': { name: 'Japonya', ideo: 'democracy', manpower: 125000, factories: 200, money: 8000, army: 400 },
    'IND': { name: 'Hindistan', ideo: 'democracy', manpower: 1400000, factories: 120, money: 4000, army: 1800 },
    'BRA': { name: 'Brezilya', ideo: 'democracy', manpower: 214000, factories: 80, money: 2500, army: 500 },
    'IRN': { name: 'İran', ideo: 'theocracy', manpower: 88000, factories: 50, money: 1200, army: 700 },
    'GRC': { name: 'Yunanistan', ideo: 'democracy', manpower: 10000, factories: 25, money: 600, army: 200 },
    'AZE': { name: 'Azerbaycan', ideo: 'autocracy', manpower: 10000, factories: 20, money: 500, army: 150 },
    'ARM': { name: 'Ermenistan', ideo: 'neutral', manpower: 3000, factories: 5, money: 100, army: 60 },
    'UKR': { name: 'Ukrayna', ideo: 'democracy', manpower: 35000, factories: 40, money: 800, army: 600 },
    'ISR': { name: 'İsrail', ideo: 'democracy', manpower: 9000, factories: 60, money: 3000, army: 400 },
    'EGY': { name: 'Mısır', ideo: 'autocracy', manpower: 110000, factories: 40, money: 1000, army: 600 }
};

const IDEOLOGIES = {
    'democracy': { name: 'Demokrasi', color: '#38bdf8' },
    'autocracy': { name: 'Otokrasi', color: '#ef4444' },
    'neutral': { name: 'Bağlantısız', color: '#94a3b8' },
    'theocracy': { name: 'Teokrasi', color: '#10b981' }
};

const Game = {
    date: new Date(2025, 0, 1),
    player: 'TUR',
    nations: {},
    provinces: {},
    selected: null,
    tab: 'prod',
    map: null,
    
    pp: 250, 
    stability: 100,
    
    init: function() {
        if(!document.getElementById('map')) return console.error("Map container missing!");
        
        this.map = L.map('map', { center: [39, 35], zoom: 5, minZoom: 2, maxZoom: 6, zoomControl: false, attributionControl: false });
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png', { opacity: 0.4 }).addTo(this.map);

        this.initNation(this.player, REAL_DB[this.player]);
        this.updateHeader();

        fetch('https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json')
            .then(r => r.json())
            .then(d => this.loadData(d))
            .catch(e => { console.error(e); this.notify("Harita verisi yüklenemedi!", "error"); });
            
        this.notify("KOMUTAN: Sistem aktif. Türkiye yönetimi sizde.", "info");
    },

    generateColor: function(str) {
        if(REAL_DB[str] && REAL_DB[str].color) return REAL_DB[str].color;
        let hash = 0;
        for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
        let h = Math.abs(hash) % 360; 
        return `hsl(${h}, 70%, 35%)`;
    },

    initNation: function(id, data = null) {
        if (!this.nations[id]) {
            if (!data) {
                let seed = id.length * 100;
                let isMicro = seed < 400;
                data = { 
                    name: id, 
                    ideo: 'neutral', 
                    manpower: isMicro ? 1000 : Math.floor(Math.random() * 20000) + 5000, 
                    factories: isMicro ? 1 : Math.floor(Math.random() * 15) + 2, 
                    money: isMicro ? 50 : Math.floor(Math.random() * 500) + 100, 
                    army: isMicro ? 5 : Math.floor(Math.random() * 100) + 20 
                };
            }

            this.nations[id] = {
                id: id, ...data,
                color: this.generateColor(id),
                relations: {}, wars: [], allies: [],
                divisions: { inf: Math.floor(data.army * 0.75), tank: Math.floor(data.army * 0.25) },
                stability: 80
            };
            this.nations[id].relations[this.player] = 0;
        }
        return this.nations[id];
    },

    loadData: function(data) {
        L.geoJSON(data, {
            style: (f) => {
                let id = this.getSafeId(f.properties);
                // Türkiye'yi tekrar oluşturma, initNation'daki veriyi koru
                if (id !== 'TUR') {
                    let base = REAL_DB[id] || { name: f.properties.name || id };
                    this.initNation(id, base);
                }

                let owner = this.provinces[id] ? this.provinces[id].owner : id;
                let color = this.nations[owner] ? this.nations[owner].color : '#333';
                
                return { fillColor: color, weight: 1, opacity: 1, color: '#000', fillOpacity: 0.65 };
            },
            onEachFeature: (f, l) => {
                let id = this.getSafeId(f.properties);
                this.provinces[id] = { id: id, owner: id, layer: l };
                
                l.on('click', (e) => { L.DomEvent.stopPropagation(e); this.select(id); });
                l.on('mouseover', () => { if(this.selected !== id) l.setStyle({ fillOpacity: 0.9, weight: 2, color: '#fff' }); });
                l.on('mouseout', () => { if(this.selected !== id) l.setStyle({ fillOpacity: 0.65, weight: 1, color: '#000' }); });
            }
        }).addTo(this.map);
        this.select(this.player);
    },

    getSafeId: function(prop) {
        let id = prop.ISO_A3 || prop.ADM0_A3 || prop.su_a3;
        if (!id) id = prop.name;
        // Türkiye Düzeltmesi
        if (id === 'Turkey' || prop.name === 'Turkey') return 'TUR';
        if (!id || id === "-99") id = prop.name || "UNKN_" + Math.floor(Math.random()*1000);
        return id.replace(/[^a-zA-Z0-9]/g, '');
    },

    select: function(id) {
        let ownerId = this.provinces[id] ? this.provinces[id].owner : id;
        if(!ownerId || !this.nations[ownerId]) return;
        
        this.selected = ownerId;
        
        Object.values(this.provinces).forEach(p => { 
            if(p.layer) {
                let isSel = (p.owner === this.selected);
                p.layer.setStyle({ weight: isSel ? 2 : 1, color: isSel ? '#fff' : '#000', fillOpacity: isSel ? 0.9 : 0.65 });
                if(isSel) p.layer.bringToFront();
            }
        });

        let n = this.nations[this.selected];
        document.getElementById('sel-name').innerText = n.name;
        document.getElementById('sel-name').style.color = n.color;
        
        let ideo = IDEOLOGIES[n.ideo] || IDEOLOGIES['neutral'];
        document.getElementById('sel-ideo').innerText = ideo.name;
        document.getElementById('sel-ideo').style.color = ideo.color;

        let statusText = n.wars.length > 0 ? "SAVAŞTA" : "BARIŞTA";
        document.getElementById('sel-status').innerHTML = `<span style="color:${n.wars.length > 0 ? 'var(--neon-red)' : 'var(--neon-green)'}">${statusText}</span>`;

        let isMe = (n.id === this.player);
        let intel = isMe || n.allies.includes(this.player);

        document.getElementById('sel-rel').innerText = n.relations[this.player] || 0;
        let totalArmy = n.divisions.inf + n.divisions.tank;
        document.getElementById('sel-army').innerText = intel ? totalArmy + " Tümen" : "Bilinmiyor";
        document.getElementById('sel-money').innerText = intel ? n.money + "$" : "???";
        document.getElementById('sel-fac').innerText = intel ? n.factories : "???";

        this.renderButtons(n);
    },

    renderButtons: function(target) {
        const area = document.getElementById('action-area');
        area.innerHTML = '';
        let isMe = (target.id === this.player);
        let p = this.nations[this.player];

        if(this.tab === 'prod') {
            if(isMe) {
                this.btn(area, 'Piyade', '150$ / 1K Asker', 'fa-person-rifle', 'btn-war', () => this.produce('inf'));
                this.btn(area, 'Tank', '500$ / 200 Asker', 'fa-shield-dog', 'btn-war', () => this.produce('tank'));
                this.btn(area, 'Fabrika', '+Gelir / 1200$', 'fa-city', 'btn-eco', () => this.build('civ'));
                this.btn(area, 'Propaganda', '+%5 İstikrar / 50 PP', 'fa-bullhorn', '', () => this.propaganda());
            } else {
                area.innerHTML = `<div style='color:#64748b; padding:20px; text-align:center; width:100%'>
                    <i class="fa-solid fa-lock" style="font-size:30px; margin-bottom:10px;"></i><br>
                    Yabancı devlet yönetilemez.
                </div>`;
            }
        } else if(this.tab === 'diplo') {
            if(!isMe) {
                if(p.wars.includes(target.id)) {
                    this.btn(area, 'SALDIR', 'Tüm Güçle', 'fa-burst', 'btn-war', () => this.combat(p, target));
                    this.btn(area, 'Barış', 'Teklif Et', 'fa-dove', 'btn-eco', () => this.offerPeace(target));
                } else {
                    this.btn(area, 'SAVAŞ AÇ', '50 PP / -10 Stab', 'fa-skull', 'btn-war', () => this.declareWar(target));
                    this.btn(area, 'İlişki Artır', '15 PP', 'fa-handshake', '', () => this.improveRel(target));
                    this.btn(area, 'Yardım Et', '250$', 'fa-sack-dollar', 'btn-eco', () => this.sendAid(target));
                    if(!p.allies.includes(target.id)) {
                        this.btn(area, 'İttifak', '100 PP', 'fa-link', '', () => this.offerAlliance(target));
                    }
                }
            } else {
                 area.innerHTML = `<div style='color:#64748b; padding:20px; text-align:center;'>Yerli Diplomasi Yapılamaz.</div>`;
            }
        } else if (this.tab === 'intel') {
            this.btn(area, 'Casusluk', '50$ / Orduyu Gör', 'fa-user-secret', '', () => {
                 if(p.money >= 50) {
                     p.money -= 50;
                     this.notify(`${target.name} ordusu: ${target.divisions.inf} P, ${target.divisions.tank} T`, "info");
                     this.updateHeader();
                 } else this.notify("Para yetersiz.", "error");
            });
        }
    },

    btn: function(parent, title, sub, icon, cls, cb) {
        let b = document.createElement('div');
        b.className = 'cmd-btn ' + cls;
        b.innerHTML = `<i class="fa-solid ${icon}"></i><span>${title}</span><small>${sub}</small>`;
        b.onclick = (e) => { cb(); if(this.selected) this.select(this.selected); };
        parent.appendChild(b);
    },

    produce: function(type) {
        let p = this.nations[this.player];
        if(type === 'inf') {
            if(p.money >= 150 && p.manpower >= 1000) {
                p.money -= 150; p.manpower -= 1000; p.divisions.inf++;
                this.notify("Piyade eğitildi.", "success");
            } else this.notify("Kaynak Yetersiz!", "error");
        } else if(type === 'tank') {
            if(p.money >= 500 && p.manpower >= 200) {
                p.money -= 500; p.manpower -= 200; p.divisions.tank++;
                this.notify("Tank üretildi.", "success");
            } else this.notify("Kaynak Yetersiz!", "error");
        }
        this.updateHeader();
    },

    build: function(type) {
        let p = this.nations[this.player];
        if(p.money >= 1200) {
            p.money -= 1200; p.factories++;
            this.notify("Fabrika kuruldu.", "success");
            this.updateHeader();
        } else this.notify("Para yetersiz (1200$)", "error");
    },
    
    propaganda: function() {
        if(this.pp >= 50) {
            this.pp -= 50; this.stability = Math.min(100, this.stability + 5);
            this.notify("Halk desteği arttı.", "success");
            this.updateHeader();
        } else this.notify("Yetersiz PP", "error");
    },

    declareWar: function(target) {
        let p = this.nations[this.player];
        if(p.wars.includes(target.id)) return;
        if(this.pp < 50) return this.notify("Yetersiz PP!", "error");
        
        this.pp -= 50; this.stability -= 10;
        this.startWar(p, target);
        this.updateHeader();
    },

    startWar: function(attacker, defender) {
        if(attacker.wars.includes(defender.id)) return;
        attacker.wars.push(defender.id); defender.wars.push(attacker.id);
        attacker.relations[defender.id] = -100; defender.relations[attacker.id] = -100;
        this.notify(`${attacker.name}, ${defender.name} ile savaşa girdi!`, "news-war");
        
        defender.allies.forEach(id => {
            let ally = this.nations[id];
            if(ally && !ally.wars.includes(attacker.id)) this.startWar(ally, attacker);
        });
        
        if(defender.id !== this.player) this.aiWarProduction(defender);
    },

    combat: function(attacker, defender) {
        let attScore = (attacker.divisions.inf) + (attacker.divisions.tank * 5);
        let defScore = (defender.divisions.inf * 1.5) + (defender.divisions.tank * 6);
        
        let lossA = Math.max(1, Math.floor(attacker.divisions.inf * 0.1));
        let lossD = Math.max(1, Math.floor(defender.divisions.inf * 0.1));
        
        attacker.divisions.inf = Math.max(0, attacker.divisions.inf - lossA);
        defender.divisions.inf = Math.max(0, defender.divisions.inf - lossD);

        if (attScore > defScore * 1.2) {
            this.conquer(attacker, defender);
        } else if (attScore > defScore) {
            this.notify(`Saldırı başarılı. Düşman kayıp verdi.`, "news-win");
        } else {
            this.notify(`Saldırı başarısız. Kayıp verdik.`, "error");
        }
        this.updateHeader();
    },

    conquer: function(winner, loser) {
        this.notify(`${winner.name}, ${loser.name} devletini fethetti!`, "news-win");
        for(let pid in this.provinces) {
            if(this.provinces[pid].owner === loser.id) {
                this.provinces[pid].owner = winner.id;
                this.provinces[pid].layer.setStyle({ fillColor: winner.color });
            }
        }
        winner.factories += Math.floor(loser.factories * 0.5);
        winner.money += loser.money;
        loser.divisions = {inf:0, tank:0}; loser.factories = 0;
        
        winner.wars = winner.wars.filter(id => id !== loser.id);
        Object.values(this.nations).forEach(n => {
            if(n.wars.includes(loser.id)) {
                n.wars = n.wars.filter(id => id !== loser.id);
            }
        });
    },
    
    offerPeace: function(target) {
        let p = this.nations[this.player];
        if(target.divisions.inf < p.divisions.inf * 0.5) {
            this.endWar(p, target);
            this.notify("Barış kabul edildi.", "success");
        } else this.notify("Barış reddedildi.", "error");
    },
    
    endWar: function(n1, n2) {
        n1.wars = n1.wars.filter(id => id !== n2.id);
        n2.wars = n2.wars.filter(id => id !== n1.id);
    },

    improveRel: function(target) {
        if(this.pp >= 15) {
            this.pp -= 15;
            if(!target.relations[this.player]) target.relations[this.player] = 0;
            target.relations[this.player] += 15;
            this.notify("İlişkiler arttı.", "success");
            this.updateHeader();
        } else this.notify("Yetersiz PP", "error");
    },

    sendAid: function(target) {
        let p = this.nations[this.player];
        if(p.money >= 250) {
            p.money -= 250; target.money += 250;
            if(!target.relations[this.player]) target.relations[this.player] = 0;
            target.relations[this.player] += 30;
            this.notify("Para gönderildi.", "success");
            this.updateHeader();
        } else this.notify("Yetersiz Para", "error");
    },
    
    offerAlliance: function(target) {
        if(this.pp < 100) return this.notify("Yetersiz PP", "error");
        if ((target.relations[this.player] || 0) > 50) {
            this.pp -= 100;
            target.allies.push(this.player);
            this.nations[this.player].allies.push(target.id);
            this.notify("İttifak kuruldu!", "success");
            this.updateHeader();
        } else this.notify("Reddedildi (İlişki > 50 olmalı)", "error");
    },

    aiLoop: function() {
        Object.values(this.nations).forEach(ai => {
            if(ai.id === this.player) return;
            
            let upkeep = (ai.divisions.inf * 2) + (ai.divisions.tank * 10);
            ai.money += (ai.factories * 20) - upkeep;
            ai.manpower += 300;
            if(ai.money < 0) { ai.money = 0; ai.divisions.tank = Math.max(0, ai.divisions.tank-1); }

            if(ai.wars.length > 0) {
                this.aiWarProduction(ai);
                ai.wars.forEach(eid => {
                    let enemy = this.nations[eid];
                    if(enemy && (ai.divisions.inf + ai.divisions.tank*5) > (enemy.divisions.inf + enemy.divisions.tank*5)*0.8) {
                        this.combat(ai, enemy);
                    }
                });
            } else {
                if(ai.money > 2000) { ai.money-=1200; ai.factories++; }
                if(Math.random() > 0.99 && ai.ideo === 'autocracy') {
                     let targets = Object.values(this.nations).filter(n => n.id !== ai.id);
                     let t = targets[Math.floor(Math.random()*targets.length)];
                     if(t) this.startWar(ai, t);
                }
            }
        });
    },
    
    aiWarProduction: function(ai) {
        while(ai.money > 200 && ai.manpower > 1000) {
            if(ai.money > 500 && Math.random()>0.7) { ai.money-=500; ai.manpower-=200; ai.divisions.tank++; }
            else { ai.money-=150; ai.manpower-=1000; ai.divisions.inf++; }
        }
    },

    nextTurn: function() {
        this.date.setMonth(this.date.getMonth() + 1);
        let p = this.nations[this.player];
        
        let upkeep = (p.divisions.inf * 2) + (p.divisions.tank * 10);
        p.money += (p.factories * 20) - upkeep;
        p.manpower += 1500;
        this.pp = Math.min(2000, this.pp + 10 + (this.stability/10));

        this.aiLoop();
        this.updateHeader();
        if(this.selected) this.select(this.selected);
    },

    updateHeader: function() {
        if(!this.nations[this.player]) return;
        let p = this.nations[this.player];
        const months = ["OCA", "ŞUB", "MAR", "NİS", "MAY", "HAZ", "TEM", "AĞU", "EYL", "EKİ", "KAS", "ARA"];
        document.getElementById('game-date').innerText = `${months[this.date.getMonth()]} ${this.date.getFullYear()}`;
        document.getElementById('res-pp').innerText = Math.floor(this.pp);
        document.getElementById('res-money').innerText = p.money + "$";
        document.getElementById('res-man').innerText = (p.manpower/1000).toFixed(1) + "K";
        document.getElementById('res-fac').innerText = p.factories;
        document.getElementById('res-stab').innerText = Math.floor(this.stability) + "%";
    },

    notify: function(msg, type) {
        let feed = document.getElementById('news-feed');
        let item = document.createElement('div');
        item.className = 'news-item ' + (type === 'news-war' ? 'news-war' : (type === 'news-win' ? 'news-win' : ''));
        if(type === 'error') item.style.borderLeftColor = '#ef4444';
        item.innerHTML = `<span>${msg}</span>`;
        feed.prepend(item);
        if(feed.children.length > 5) feed.lastChild.remove();
        setTimeout(() => item.remove(), 4000);
    },

    setTab: function(t) {
        this.tab = t;
        document.querySelectorAll('.tab').forEach(e => e.classList.remove('active'));
        let tg = event.target; while(!tg.classList.contains('tab')) tg = tg.parentElement;
        tg.classList.add('active');
        if(this.selected) this.renderButtons(this.nations[this.selected]);
    }
};

// Sayfa yüklendiğinde başlat (Hata önleyici)
window.onload = function() {
    Game.init();
};

</script>
</body>
</html>
